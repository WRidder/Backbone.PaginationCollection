!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o;"undefined"!=typeof window?o=window:"undefined"!=typeof global?o=global:"undefined"!=typeof self&&(o=self),o.VirtualCollection=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){(function(global){function sortedIndexTwo(array,obj,iterator,context){for(var low=0,high=array.length;high>low;){var mid=low+high>>>1;iterator.call(context,obj,array[mid])>0?low=mid+1:high=mid}return low}var VirtualCollection,Backbone="undefined"!=typeof window?window.Backbone:"undefined"!=typeof global?global.Backbone:null,_="undefined"!=typeof window?window._:"undefined"!=typeof global?global._:null;VirtualCollection=Backbone.Collection.extend({constructor:function(collection,options){options=options||{},this.collection=collection,void 0!==options.comparator&&(this.comparator=options.comparator),options.close_with&&this.bindLifecycle(options.close_with,"close"),options.destroy_with&&this.bindLifecycle(options.destroy_with,"destroy"),this.model||(this.model=collection.model),this.accepts=VirtualCollection.buildFilter(options.filter),this._rebuildIndex(),this.listenTo(this.collection,"add",this._onAdd),this.listenTo(this.collection,"remove",this._onRemove),this.listenTo(this.collection,"change",this._onChange),this.listenTo(this.collection,"reset",this._onReset),this.listenTo(this.collection,"sort",this._onSort),this.initialize.apply(this,arguments)},bindLifecycle:function(view,method_name){view.on(method_name,_.bind(this.stopListening,this))},updateFilter:function(filter){return this.accepts=VirtualCollection.buildFilter(filter),this._rebuildIndex(),this.trigger("filter",this,filter),this.trigger("reset",this,filter),this},_rebuildIndex:function(){for(idx in this.models)this.models[idx].off("all",this._onAllEvent,this);this._reset(),this.collection.each(function(model,i){this.accepts(model,i)&&(model.on("all",this._onAllEvent,this),this.models.push(model),this._byId[model.cid]=model,model.id&&(this._byId[model.id]=model))},this),this.length=this.models.length,this.comparator&&this.sort({silent:!0})},orderViaParent:function(options){this.models=this.collection.filter(function(model){return void 0!==this._byId[model.cid]},this),options.silent||this.trigger("sort",this,options)},_onSort:function(collection,options){void 0===this.comparator&&this.orderViaParent(options)},_onAdd:function(model,collection,options){var already_here=this.get(model);!already_here&&this.accepts(model,options.index)&&(this._indexAdd(model),model.on("all",this._onAllEvent,this),this.trigger("add",model,this,options))},_onRemove:function(model,collection,options){if(this.get(model)){var i=this._indexRemove(model),options_clone=_.clone(options);options_clone.index=i,model.off("all",this._onAllEvent,this),this.trigger("remove",model,this,options_clone)}},_onChange:function(model,options){if(model&&options){var already_here=this.get(model);if(this.accepts(model,options.index))already_here?this.trigger("change",model,this,options):(this._indexAdd(model),this.trigger("add",model,this,options));else if(already_here){var i=this._indexRemove(model),options_clone=_.clone(options);options_clone.index=i,this.trigger("remove",model,this,options_clone)}}},_onReset:function(collection,options){this._rebuildIndex(),this.trigger("reset",this,options)},sortedIndex:function(model,value,context){var iterator=_.isFunction(value)?value:function(target){return target.get(value)};return 1==iterator.length?_.sortedIndex(this.models,model,iterator,context):sortedIndexTwo(this.models,model,iterator,context)},_indexAdd:function(model){if(!this.get(model)){var i;i=this.comparator?this.sortedIndex(model,this.comparator,this):void 0===this.comparator?this.sortedIndex(model,function(target){return this.collection.indexOf(target)},this):this.length,this.models.splice(i,0,model),this._byId[model.cid]=model,model.id&&(this._byId[model.id]=model),this.length+=1}},_indexRemove:function(model){model.off("all",this._onAllEvent,this);var i=this.indexOf(model);return-1===i?i:(this.models.splice(i,1),delete this._byId[model.cid],model.id&&delete this._byId[model.id],this.length-=1,i)},_onAllEvent:function(eventName){var explicitlyHandledEvents=["add","remove","change","reset","sort"];_.contains(explicitlyHandledEvents,eventName)||this.trigger.apply(this,arguments)}},{buildFilter:function(options){return options?_.isFunction(options)?options:options.constructor===Object?function(model){return!Boolean(_(Object.keys(options)).detect(function(key){return model.get(key)!==options[key]}))}:void 0:function(){return!0}}}),_.each(["add","remove","set","reset","push","pop","unshift","shift","slice","sync","fetch"],function(method_name){VirtualCollection.prototype[method_name]=function(){return this.collection[method_name].apply(this.collection,_.toArray(arguments))}}),_.extend(VirtualCollection.prototype,Backbone.Events),module.exports=VirtualCollection}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});